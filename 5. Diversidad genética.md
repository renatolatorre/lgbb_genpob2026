# Análisis de diversidad genética
La diversidad genética dentro de individuos y poblaciones proporciona información clave sobre:
- Historia demográfica
- Tamaño efectivo poblacional
- Endogamia
- Flujo génico
- Estructura genética

## 1. Heterocigosidad global
La heterocigosidad individual es la relación entre el número de sitios heterocigotos respecto del número total de sitios evaluados. Para datos de NGS, estimamos esta cantidad mediante el Espectro de Frecuencia de Sitios (SFS) individual.
```bash
mkdir 5-diversidad
cd 5-diversidad
cp /data/courses/course2026/course_files/scripts/diversidad/*.sh .
```
### 1.1 Estimación del SFS individual
Usando ANGSD, estimamos probabilidades de genotipo a nivel individual, a partir del cual obtendremos una estimación del SFS:
```bash
sbatch 1-angsd_saf.sh
```
El archivo `sfs` contiene las probabilidades en orden:
```
p(AA)  p(Aa)  p(aa)
```
Donde:
- AA = homocigoto para el alelo mayor
- Aa = heterocigoto
- aa = homocigoto para el alelo menor

### 1.2 Estimación del SFS individual
La heterocigosidad corresponde a la frecuencia de heterocigotos:
```bash
awk '{print $2 / ($1 + $2 + $3)}' file.sfs
```
> [!IMPORTANT]
> :question: ¿Qué indica una heterocigosidad alta con respecto al tamaño efectivo poblacional?  
> :question: ¿Qué procesos pueden reducir la heterocigosidad?

## 2. Heterocigosidad en ventanas genómicas
La heterocigosidad no es uniforme a lo largo del henoma. Regiones con baja heterocigosidad pueden indicar:
- Selección reciente
- ROH
- Baja recombinación

### 2.1 Estimación de theta por sitio
La heterocigosidad a nivel poblacional se encapsula en los estimados de theta. Podemos obtener un estimado global y en ventanas de la siguiente manera:
```bash
sbatch 2-angsd_theta.sh
```
### 2.2 Estimación en ventanas
Calculamos los índices de diversidad nucleotídica y theta de Watterson en ventanas de 50 kb:
```bash
sbatch 3-angsd_theta_window.sh
```
> [!IMPORTANT]
> :question: ¿Cuál es la diferencia entre pi y theta?  
> :question: ¿Por qué varían estos valores a lo largo del genoma?  
> :question: ¿Qué regiones muestran menor diversidad? ¿Hay alguna coincidencia con regiones de baja o alta densidad génica?

## 3. Densidad de variantes
La densidad de SNPs es un indicador directo de diversidad genética. Para esto, primero obtenemos las posiciones a partir del archivo `beagle`:
```bash
zcat file.beagle.gz | sed '1d' | cut -f1 | sed 's/_/\t/' > SNP_positions.txt
```
Luego, convertimos a formato BED:
```bash
awk '{print $1 "\t" $2-1 "\t" $2}' SNP_positions.txt > SNP_positions.bed
```
### 3.1 Densidad de variantes en ventanas
Para esto usaremos las herramientas de `bedtools`:
```bash
sbatch 4-SNP_density.sh
```
Los resultados pueden visualizarse usando R.
> [!IMPORTANT]
> :question: ¿Cómo se relaciona la densidad de SNPs con la heterocigosidad?  
> :question: ¿Qué procesos pueden generar regiones con baja densidad de SNPs?

## 4. Relaciones de parentesco
Usando las probabilidades de genotipo, estimaremos coeficientes de parentesco entre individuos. Esto permite detectar relaciones biológicas o artificiales como:
- Hermanos, padres-hijos
- Muestras duplicadas
- Individuos no relacionados

### 4.1 Ejecutar NGSrelate
Usando el archivo `beagle` filtrado:
```bash
sbatch 5-relatedness.sh
```
Obtenemos varios valores, de los cuales el coeficiente de parentesco nos permite tener una idea de la relación entre individuos:

| Coeficiente de parentesco | Relación|
|----------------------------|--------|
| 0.5  |  Mismo individuo o gemelos idénticos|
| 0.25 |  Relación padre-hijo|
| 0.25 |  Hermanos completos|
| 0.125 | Relación abuelo-nieto|
| 0.125 | Medio hermanos|
| 0.0625 | Primos de primer grado|

> [!IMPORTANT]
> :question: ¿Hay individuos cercanamente relacionados en la muestra?  
> :question: ¿Por qué es importante detectar individuos relacionados en análisis poblacionales?

### 4.2 Coeficiente de endogamia
Por otro lado, obtenemos una estimación del nivel de endogamia `F` para cada individuo. Este es la probabilidad de que un individuo posee dos alelos en un locus que son idénticos por descendencia (IBD) de un ancestro en común.

El coeficiente de endogamia va de 0 a 1 y mide la homocigosidad en un individuo debido al parentesco entre los padres. Mientras el valor de F es más alto, indica una mayor homocigosidad, lo cual puede llevar a depresión endogámica.

> [!IMPORTANT]
> :question: ¿Qué individuos muestran un mayor coeficiente de endogamia? ¿POr qué?
