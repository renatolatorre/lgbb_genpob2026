# Análisis de estructura genética poblacional
Uno de los alcances de un enfoque genómico-poblacional es que permite emplear variantes a lo largo del genoma para obtener una aproximación precisa de la estructura genética poblacional. Sin embargo, necesitamos filtrar sitios y regiones genómicas que puedan representar artefactos técnicos o procesos selectivos en lugar de procesos neutrales.

## 1. Filtrado de sitios
La secuenciación resulta en lecturas que cubren de manera heterogénea el genoma, con algunas regiones con profundidades muy bajas o excesivamente altas. Por otro lado, algunas regiones pueden ser complejas para el mapeo, por lo que resultan en una calidad de mapeo baja o con alineamientos ambiguos. Al incluir estos sitios, corremos el riesgo de:
- Falsos positivos (por ejemplo, SNPs erróneos)  
- Falsos negativos (variantes reales no llamadas)  
- Frecuencias alélicas (estimaciones) sesgadas  

Además, si una subpoblación muestra algunas de estas diferencias de manera sistemática con respecto al resto de subpoblaciones, los análisis de estructuración e índices de diferenciación reflejarían diferencias técnicas en lugar de biológicas.

Primero, usaremos la herramienta `CallableLoci` para detectar estas regiones en un solo genoma. Recordar cambiar el USERNAME por el nombre de grupo:

```bash
script 1-CallableLoci_ind.sh
```

Para reducir la variabilidad entre individuos de una misma población, podemos obtener un "promedio" de regiones útiles. Para conjuntos de datos de baja profundidad, es recomendable unir la información de varios individuos hasta alcanzar una profundidad en conjunto considerable (e.g., 10X).

```bash
script 2-CallableLoci_pob.sh
```

Guardaremos los resultados como un archivo `bed`. Estos guardan información a manera de coordenadas, indicando el nombre del fragmento (contig, scaffold o cromosoma), la posición de inicio y final (recordar que es "0-based", es decir, la primera base es 0, la segunda es 1, etc.).  

Dependiendo del objetivo del análisis de estructuración poblacional, podríamos buscar excluir regiones genómicas no neutrales o difíciles de estudiar. Las regiones codificantes típicamente están bajo selección negativa (en algunos casos positiva), por lo que las variantes dentro o cercanas a estas regiones influyen en la estimación de la diferenciación entre subpoblaciones. Del mismo modo, las regiones repetitivas crean artefactos técnicos debido a la dificultad del mapeo de lecturas cortas, además que pueden llevar a frecuencias alélicas particulares que violan las condiciones del llamado de variantes diploides.  

Un genoma donde se conoce la posición física de los genes y repeticiones se denomina como "físicamente anotado". La anotación puede basarse completamente en predicciones o emplear evidencia empírica para soportar modelos de genes. En esta práctica, emplearemos la información de un genoma anotado para identificar variantes dentro de regiones exónicas y repetitivas.

```bash
script 3-filtergff_to_bed.sh
```

Una vez que tengamos las coordenadas de las regiones a incluir o excluir, podemos unirlas en un solo archivo, con el cual filtraremos las variantes.

```bash
script 4-merge_beds.sh
```

Dado que trabajaremos con `angsd`, necesitamos filtrar el archivo de probabilidades de genotipo `beagle`, así como los archivos asociados que se usarán en análisis posteriores.

```bash
script 5-filter_beagle.sh
```

Métodos para estimar la estructuración poblacional como el Análisis de Componentes Principales (PCA) y ADMIXTURE asumen que las variantes son independientes. Sin embargo, SNPs cercanos físicamente en un cromosoma pueden estar ligados y tener frecuencias alélicas correlacionadas. Esto resultaría en un sesgo en el que regiones con una alta densidad de SNPs tienen más importancia en el análisis.  

Además, esta correlación es alta en regions cercanas a variantes bajo selección, incluso fuera de regiones codificantes, lo cual podría oscurecer el efecto de procesos neutrales en la estructura poblacional.  

Usaremos `plink` para encontrar regiones con alto desequilibrio de ligamiento. Tras un análisis en ventanas, seleccionaremos un SNP representativo e independiente por cada bloque.

```bash
script 6-LD_pruning.sh
```

## 2. Análisis de componentes principales
Para el PCA usaremos PCAngsd, el cual usa probabilidades de genotipos obtenidos con `angsd` para inferir la estructuración poblacional.

```bash
script 7-PCAngsd.sh
```

Estos resultados pueden interpretarse examinando la varianza a través de los componentes principales, y un ordenamiento preliminar.

```bash
script 8-PlotAngsd.R
```

Pueden haber casos en los que necesitamos repetir el análisis excluyendo individuos con patrones de diversidad genética muy distintos. La explicación depende del sistema de estudio, y podría responder a errores en la colecta, procesamiento o análisis, o a fenómenos naturales como hibridación.

```bash
script 9-remove_ind_angsd.sh
```

Podemos repetir el PCA y ver los nuevos resultados.

## 3. ADMIXTURE
El análisis de ancestría ADMIXTURE toma variantes genéticas independientes y ubica a los individuos en grupos determinados. Cada corrida es distinta, por lo que una estrategia recomendada es probar varias y elegir la más verosímil. Asimismo, probamos distintos números de grupos a fin de desafiar nuestras hipótesis a priori.

```bash
script 10-iterate_admixture.sh
```

La interpretación del número de grupos es integral, tomando en cuenta tanto la distribución espacial de las muestras como algún otro posible factor que las diferencie. Una estrategia es comparar los resultados con los de PCA, de modo que se cuenta con dos evidencias de estructuración poblacional.

```bash
script 11-plot_admixture.R
```
