# Análisis de estructura genética poblacional
La estructura genética poblacional responde una pregunta central:
> ¿Cómo se distribuye la variación genética entre individuos y poblaciones?

Con un enfoque genómico, miles o millones de SNPs pueden revelar patrones demográficos sutiles. Sin embargo, **más datos no siempre se traducen en mejores resultados**. La calidad y naturaleza de los datos determinan la validez de la inferencia.

## 1. Filtrado de sitios
Antes de inferir la estructura poblacional, debemos asegurarnos de que los sitios analizados reflejen procesos biológicos reales (deriva, migración, historia demográfica) y no artefactos técnicos o selección.
Si no filtramos estos sitios podemos obtener:
- Falsos positivos (por ejemplo, SNPs erróneos)  
- Falsos negativos (variantes reales no llamadas)  
- Frecuencias alélicas (estimaciones) sesgadas
- Estructura artificial debido a la cobertura desigual

> [!IMPORTANT]
> :question: ¿Qué pasaría si una población tiene sistemáticamente menor cobertura que otra? ¿Cómo influiría en la estimación de la diferenciación (e.g. F<sub>ST</sub>) o en la agrupación en el análisis de componentes principales (PCA)?

### 1.1 Regiones válidas para el llamado de variantes
Primero, detectamos regiones del genoma donde podemos llamar variantes con confianza. Recordar cambiar el USERNAME por el nombre de grupo:
```bash
script 1-CallableLoci_ind.sh
```
Notar que para esta práctica se tomaron como límites inferior y superior 1/3X y 3X, respectivamente, a partir de la profundidad promedio. Se recomienda ajustar estos valores según el conjunto de datos con el que se esté trabajando y el objetivo de los análisis posteriores.

> [!IMPORTANT]
> :bulb: ¿Cuántas bases válidas se obtienen para cada individuo?  
> :bulb: ¿Hay individuos con mucho menos genoma usable?  
> :bulb: ¿Cuánto de las regiones retenidas y excluídas son compartidas/exclusivas entre los individuos? Pista: usar `bedtools intersect`

Para conjuntos de datos de baja profundidad, podemos combinar individuos por población:
```bash
script 2-CallableLoci_pob.sh
```
Tomamos como punto de referencia la profundidad promedio en conjunto. Se recomienda alcanzar una profundidad mínima considerable (e.g. 10X).

> [!IMPORTANT]
> :question: ¿Por qué es preferible buscar regiones válidas compartidas entre individuos de una población al estimar estructura?

Guardaremos los resultados como un archivo `bed`. Estos guardan información a manera de coordenadas, indicando el nombre del fragmento (contig, scaffold o cromosoma), la posición de inicio y final.
```bash
less -S bedfile
```
Recordar que el formato `bed` es "0-based", es decir, la primera base es 0, la segunda es 1, etc.

### 1.2 Exclusión de regiones codificantes y repetitivas
Cuando nuestro objetivo es inferir la estructura mediada por procesos neutrales, debemos minimizar la influencia de la selección,
- Regiones codificantes: típicamente bajo selección purificadora o positiva.
- Repeticiones: pueden ocasionar errores de mapeo y colapso de copias.

Aprovecharemos el genoma de referencia anotado para esta práctica, el cual incluye información sobre la ubicación de genes y repeticiones.
```bash
script 3-filtergff_to_bed.sh
script 4-merge_beds.sh
```
> [!IMPORTANT]
> :question: ¿Cómo y por qué cambiaría la estructura al incluir variantes en regiones codificantes?

### 1.3 Filtrado del archivo beagle
Dado que usamos `angsd`, necesitamos filtrar el archivo de probabilidades de genotipo `beagle`, así como los archivos asociados que se usarán en análisis posteriores.
```bash
script 5-filter_beagle.sh
```
> [!IMPORTANT]
> :question: ¿Por qué usamos probabilidades de genotipos para datos de baja profundidad?

### 1.4 LD pruning
PCA y ADMIXTURE asumen marcadores (SNPs) independientes. Si no filtramos SNPs en alto LD, corremos el riesgo de:
- Sobreestimar la importancia de regiones con una alta densidad de SNPs correlacionados.
- Oscurecer el efecto de procesos neutrales en la estructura debido al efecto de SNPs cercanos a una región bajo selección.

Usaremos `plink` para encontrar regiones con alto desequilibrio de ligamiento. Tras un análisis en ventanas, seleccionaremos un SNP representativo e independiente por cada bloque.
```bash
script 6-LD_pruning.sh
```
> [!IMPORTANT]
> :question: ¿Cuántos SNPs se retuvieron después del filtrado?  
> :bulb: ¿Qué ocurre si probamos con distintos parámetros de r<sup>2</sup>? Por ejemplo, probar r<sup>2</sup> = 0.1, 0.2, 0.5.  
> :bulb: ¿Qué ocurre si probamos con distintos tipos y tamaños de ventana?  

## 2. Análisis de componentes principales
Usaremos `PCAngsd`, el cual usa probabilidades de genotipos obtenidos con `angsd` para inferir la estructuración poblacional.
```bash
script 7-PCAngsd.sh
```
El PCA resume variación genética en ejes ortogonales. Primero, exploremos la distribución de la varianza a través de los ejes. Luego, el ordenamiento de las muestras en el plano conformado por el PC1 y PC2.
```bash
script 8-PlotAngsd.R
```
> [!IMPORTANT]
> :question: ¿Cuánta varianza explica el PC1? ¿El PC2 y PC3?  
> :question: La distribución de las muestras es consistente con la ubicación geográfica?  
> :question: ¿Hay individuos ordenados de manera extrema (outliers)?
> :bulb: ¿Cómo cambia la agrupación si examinamos el PC2 vs PC3? ¿Siguen algún patrón identificable?

¿Qué hacer con los outliers? Primero debemos preguntarnos de dónde vienen, pues pueden surgir de errores técnicos como una muestra mal identificada o etiquetada; o fenómenos naturales como hibridación, especies crípticas o migrantes recientes.
```bash
script 9-remove_ind_angsd.sh
```
> [!IMPORTANT]
> :question: ¿Qué otras explicaciones pueden haber para los outliers en un PCA?

> [!IMPORTANT]
> > :bulb: Probar incluyendo/excluyendo regiones codificantes/repetitivas en los análisis posteriores. En el PCA, ¿cómo cambian los ejes principales y la agrupación de muestras?  
> :bulb: Probar incluyendo/excluyendo variantes en LD en los análisis posteirores. En el PCA, ¿cómo cambian los ejes principales y la agrupación de muestras?

## 3. ADMIXTURE
ADMIXTURE asigna proporciones de ancestría bajo un modelo de K poblaciones. Cada corrida puede diferir, por lo que se recomienda probar con múltiples corridas y múltiples K.
```bash
script 10-iterate_admixture.sh
```

La interpretación del número de grupos es integral, tomando en cuenta tanto la distribución espacial de las muestras como algún otro posible factor que las diferencie. Una estrategia es comparar los resultados con los de PCA, de modo que se cuenta con dos evidencias de estructuración poblacional.

```bash
script 11-plot_admixture.R
```
> [!IMPORTANT]
> :question: ¿Coinciden los grupos obtenidos en ADMIXTURE y PCA?
> :question: ¿Coinciden individuos intermedios en PCA con ancestría mixta en ADMIXTURE?
