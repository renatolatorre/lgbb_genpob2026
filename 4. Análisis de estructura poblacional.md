# Análisis de estructura genética poblacional
La estructura genética poblacional responde una pregunta central:
> ¿Cómo se distribuye la variación genética entre individuos y poblaciones?

Con un enfoque genómico, miles o millones de SNPs pueden revelar patrones demográficos sutiles. Sin embargo, **más datos no siempre se traducen en mejores resultados**. La calidad y naturaleza de los datos determinan la validez de la inferencia.

## 1. Filtrado de sitios
Antes de inferir la estructura poblacional, debemos asegurarnos de que los sitios analizados reflejen procesos biológicos reales (deriva, migración, historia demográfica) y no artefactos técnicos o selección.
Si no filtramos estos sitios podemos obtener:
- Falsos positivos (por ejemplo, SNPs erróneos)  
- Falsos negativos (variantes reales no llamadas)  
- Frecuencias alélicas (estimaciones) sesgadas
- Estructura artificial debido a la cobertura desigual

> [!IMPORTANT]
> :question: ¿Qué pasaría si una población tiene sistemáticamente menor cobertura que otra? ¿Cómo influiría en la estimación de la diferenciación (e.g. F<sub>ST</sub>) o en la agrupación en el análisis de componentes principales (PCA)?

### 1.1 Regiones válidas para el llamado de variantes
Comenzamos creando el espacio de trabajo:
```bash
mkdir 4-filtrado_variantes
cd 4-filtrado_variantes
cp /data/courses/course2026/course_files/scripts/estructura/*.sh .
cp /data/courses/course2026/course_files/variantes_estructura/* .
```
Primero, detectamos regiones del genoma donde podemos llamar variantes con confianza. Recordar cambiar el USERNAME por el nombre de grupo:
```bash
sbatch 1-CallableLoci_ind.sh
```
Notar que para esta práctica se tomaron como límites inferior y superior 1/3X y 3X, respectivamente, a partir de la profundidad promedio. Se recomienda ajustar estos valores según el conjunto de datos con el que se esté trabajando y el objetivo de los análisis posteriores.  
Examinemos los resultados
```bash
cat FIELD_LAM34.ppa_v2.asm.CL.summary
```

> [!IMPORTANT]
> :exclamation: Repetir la experiencia para la muestra `HUSM_LAM25.ppa_v2.asm.bam`. ¿Cuántas bases válidas se obtienen para cada individuo?  
> :exclamation: ¿Cuánto de las regiones retenidas y excluídas son compartidas/exclusivas entre los individuos? Pista: usar `bedtools intersect`

Para conjuntos de datos de baja profundidad, podemos combinar individuos por población:
```bash
cp /data/courses/course2026/course_files/bam_file.list .
sbatch 2-CallableLoci_pob.sh
```
Tomamos como punto de referencia la profundidad promedio en conjunto. Se recomienda alcanzar una profundidad mínima considerable (e.g. 10X).

> [!IMPORTANT]
> :question: ¿Por qué es preferible buscar regiones válidas compartidas entre individuos de una población al estimar estructura?

Guardaremos los resultados como un archivo `bed`. Estos guardan información a manera de coordenadas, indicando el nombre del fragmento (contig, scaffold o cromosoma), la posición de inicio y final.
```bash
less -S HUSM_NORTH.CL.bed
grep -v "CALLABLE" HUSM_NORTH.CL.bed | cut -f1-3 > HUSM_NORTH.CL.exclude.bed
```
Recordar que el formato `bed` es "0-based", es decir, la primera base es 0, la segunda es 1, etc.

### 1.2 Exclusión de regiones codificantes y repetitivas
Cuando nuestro objetivo es inferir la estructura mediada por procesos neutrales, debemos minimizar la influencia de la selección,
- Regiones codificantes: típicamente bajo selección purificadora o positiva.
- Repeticiones: pueden ocasionar errores de mapeo y colapso de copias.

Aprovecharemos el genoma de referencia anotado para esta práctica, el cual incluye información sobre la ubicación de genes y repeticiones.
```bash
script 3-filtergff_to_bed.sh
```
> [!IMPORTANT]
> :question: ¿Cómo y por qué cambiaría la estructura al incluir variantes en regiones codificantes?

### 1.3 Filtrado del archivo beagle
Dado que usamos `angsd`, necesitamos filtrar el archivo de probabilidades de genotipo `beagle`, así como los archivos asociados que se usarán en análisis posteriores. 
> [!IMPORTANT]
> :question: ¿Por qué usamos probabilidades de genotipos para datos de baja profundidad?

Primero, reuniremos todos los archivos con regiones para excluir del análisis en un solo archivo `bed`.
```bash
module load bedtools
cat file1.bed file2.bed | bedtools sort | bedtools merge > regions_to_exclude.bed
grep -v "scf" regions_to_exclude.Chr.bed
```
Luego, buscaremos todos los SNPs en el archivo `beagle` que se encuentran dentro de esas regiones:
```bash
module load bedtools
prefix="HUSM_NORTH"
gzip -d $prefix.beagle.gz
grep -v "scf" $prefix.beagle > $prefix.Chr.beagle
sed '1d' $prefix.Chr.beagle \
| cut -f1 | sed 's/_/\t/' | awk '{print $1 "\t" $2-1 "\t" $2}' \
| bedtools intersect -a - -b regions_to_exclude.Chr.bed \
| awk '{print $1 "_" $3}' > $prefix.Chr.CL.exclude.sites
```
Con la lista de SNPs a excluir, filtrearemos el archivo `beagle` y crearemos uno nuevo.
```bash
prefix="HUSM_NORTH"
awk 'NR==FNR{SNPs[$1]=$1; next} !($1 in SNPs)' $prefix.Chr.CL.exclude.sites $prefix.Chr.beagle > $prefix.Chr.filt.beagle
gzip $prefix.Chr.filt.beagle
```
> [!IMPORTANT]
> :question: ¿Cuántas variantes se retuvieron?
> :exclamation: Realizar la misma experiencia para el conjunto de datos `INGROUP_PERU`. ¿Cuál es la diferencia y por qué? Pista: revisar el nombre de los archivos usados para la estimación de probabilidades de genotipo en `INGROUP_PERU.samplelist`.

### 1.4 LD pruning
PCA y ADMIXTURE asumen marcadores (SNPs) independientes. Si no filtramos SNPs en alto LD, corremos el riesgo de:
- Sobreestimar la importancia de regiones con una alta densidad de SNPs correlacionados.
- Oscurecer el efecto de procesos neutrales en la estructura debido al efecto de SNPs cercanos a una región bajo selección.

Empezamos por filtrar los archivos en formato `plink` para que contengan la misma información que el archivo `beagle`:
```bash
prefix="HUSM_NORTH"
grep -v "scf" $prefix.tped > $prefix.Chr.tped
awk 'NR==FNR{SNPs[$1]=$1; next} !($2 in SNPs)' $prefix.Chr.CL.exclude.sites $prefix.Chr.tped > $prefix.Chr.filt.tped
cp $prefix.tfam $prefix.Chr.filt.tfam #No requiere filtrado ya que depende del número de individuos.
```
Usaremos `plink` para encontrar regiones con alto desequilibrio de ligamiento. Tras un análisis en ventanas, seleccionaremos un SNP representativo e independiente por cada bloque.
```bash
sbatch 4-LD_pruning.sh
```
> [!IMPORTANT]
> :question: ¿Cuántos SNPs se retuvieron después del filtrado?  
> :exclamation: ¿Qué ocurre si probamos con distintos parámetros de r<sup>2</sup>? Por ejemplo, probar r<sup>2</sup> = 0.1, 0.2, 0.5.  
> :exclamation: ¿Qué ocurre si probamos con distintos tipos y tamaños de ventana?  

De manera similar a las variantes dentro de regiones obtenidas con CallableLoci, excluiremos variantes con fuerte desequilibrio de ligamiento:
```bash
prefix="HUSM_NORTH"
gzip -d $prefix.Chr.filt.beagle.gz
head -n1 $prefix.Chr.filt.beagle > $prefix.Chr.filt.ldprune.beagle
awk 'NR==FNR{SNPs[$1]=$1; next} *$1 in SNPs' $prefix.Chr.filt.LD_prun/$prefix.Chr.filt_"$window"_"$step"_"$threshold".prune.in $prefix.Chr.filt.beagle >> $prefix.Chr.filt.ldprune.beagle
gzip $prefix.Chr.filt.ldprune.beagle
```
Además, volvemos a actualizar el archivo de `plink`:
```bash
prefix="HUSM_NORTH"
awk 'NR==FNR{SNPs[$1]=$1; next} $2 in SNPs' $prefix.Chr.filt.LD_prun/$prefix.Chr.filt_"$window"_"$step"_"$threshold".prune.in $prefix.Chr.filt.tped > $prefix.Chr.filt.ldprune.tped
cp $prefix.tfam $prefix.Chr.filt.ldprune.tfam
```
> [!IMPORTANT]
> :question: ¿Cuántos SNPs se conservaron con respecto al número inicial?

## 2. Análisis de componentes principales
Usaremos `PCAngsd`, el cual usa probabilidades de genotipos obtenidos con `angsd` para inferir la estructuración poblacional.
```bash
sbatch 5-PCAngsd.sh
```
Se generó la matriz de covarianza. Notar que además añadimos los nombres de las muestras a cada resultado para facilitar la visualización.

El PCA resume variación genética en ejes ortogonales. Primero, exploremos la distribución de la varianza a través de los ejes. Luego, el ordenamiento de las muestras en el plano conformado por el PC1 y PC2.
```bash
sbatch 6-PlotAngsd.R
```
> [!IMPORTANT]
> :question: ¿Cuánta varianza explica el PC1? ¿El PC2 y PC3?  
> :question: La distribución de las muestras es consistente con la ubicación geográfica?  
> :question: ¿Hay individuos ordenados de manera extrema (outliers)?  
> :exclamation: ¿Cómo cambia la agrupación si examinamos el PC2 vs PC3? ¿Siguen algún patrón identificable?

¿Qué hacer con los outliers? Primero debemos preguntarnos de dónde vienen, pues pueden surgir de errores técnicos como una muestra mal identificada o etiquetada; o fenómenos naturales como hibridación, especies crípticas o migrantes recientes.
> [!IMPORTANT]
> :question: ¿Qué otras explicaciones pueden haber para los outliers en un PCA?

Para remover individuos en una lista, por ejemplo "HUSM24 y HUSM25", emplear el siguiente bloque:
```bash
printf "HUSM24\nHUSM25\n" > inds_remove.txt
col_numbers=$(grep -w -n -f inds_remove.txt bam_file.list | cut -d":" -f1 \
| awk '{print 4 + 3 * ($0 - 1) "-" 3 + $0 * 3}' \
| tr -s '\n' ',' | sed 's/,$/\n/')
echo $col_numbers
cut -f$col_numbers --complement beagle_file > beagle_file_filtered
```
> [!IMPORTANT]
> :exclamation: Probar incluyendo/excluyendo regiones codificantes/repetitivas en los análisis posteriores. En el PCA, ¿cómo cambian los ejes principales y la agrupación de muestras?  
> :exclamation: Probar incluyendo/excluyendo variantes en LD. En el PCA, ¿cómo cambian los ejes principales y la agrupación de muestras?

## 3. ADMIXTURE
ADMIXTURE asigna proporciones de ancestría bajo un modelo de K poblaciones. Cada corrida puede diferir, por lo que se recomienda probar con múltiples corridas y múltiples K.
```bash
sbatch 7-iterate_admixture.sh
```
La interpretación del número de grupos es integral, tomando en cuenta tanto la distribución espacial de las muestras como algún otro posible factor que las diferencie. Una estrategia es comparar los resultados con los de PCA, de modo que se cuenta con dos evidencias de estructuración poblacional.

```bash
sbatch 8-plot_admixture.R
```
> [!IMPORTANT]
> :question: ¿Coinciden los grupos obtenidos en ADMIXTURE y PCA?
> :question: ¿Coinciden individuos intermedios en PCA con ancestría mixta en ADMIXTURE?
