# Introducción al HPC y Linux

## 1. ¿Qué es un HPC?

Un **HPC (High Performance Computing)** es un conjunto de computadoras (llamadas **nodos**) que trabajan juntas para realizar cálculos intensivos.

En este curso, el HPC se utilizará para:
- Analizar datos genómicos y de genómica de poblaciones
- Ejecutar scripts y pipelines que serían muy lentos en una laptop personal
- Aprender flujos de trabajo computacionales

### ¿Cómo se organiza un HPC?

- **Nodo de acceso / login o admin**
  - Donde nos conectamos como usuarios (`ssh`)
  - Editamos archivos, preparamos scripts y enviamos procesos o trabajos
  - **No ejecutamos directamente análisis pesados en este nodo**

- **Nodos de cómputo**
  - Donde ejecutamos los trabajos
  - Solo accedemos a estos mediante un scheduler o planificador (Slurm)

- **Sistema de archivos compartido**
  - Los mismos archivos son visibles para todos los nodos
  - Usamos directorios de trabajo temporales

---

## 2. ¿Cómo nos conectamos al HPC?

Desde la terminal local:

```bash
ssh username@162.132.238.162
```

## 3. Archivos de sistema y material del curso

Linux usa un sistema de archivos jerárquico, empezando con la raíz (`/`).

En el curso trabajaremos en ambientes grupales en la siguiente dirección:
```
/data/courses/course2026/nombre_grupo/
```
Los archivos de entrada y scripts se ubicarán dentro de una carpeta común para todos los grupos.
```
/data/courses/course2026/course_files/
```

## 4. Comandos de navegación y manipulación de archivos en Linux

- **pwd**: print working directory
```bash
pwd
```
Nos dice en qué dirección estamos. Para nuestra carpeta de inicio sería (`/data/courses/course2026/nombre_grupo/`).
- **cd**: change directory
```bash
cd directory_name
```
Este puede usarse de varias maneras. Por ejemplo, con una dirección absoluta:
```bash
cd /data/courses/course2026/course_files
```
O una dirección relativa:
```bash
cd ../neltuma # Desde mi posición, ir hacia arriba, y luego a la carpeta neltuma
```
Si me pierdo, puedo regresar a mi directorio de inicio
```bash
cd ~
```
- **ls**: list files
```bash
cd /data/courses/course2026/course_files
ls
ls -l
ls -lh
cd ~
```
Son comúnes las opciones `l` para imprimir un formato largo y `h` para mostrar tamaños de archivos más entendibles.
- **mkdir**: make directory
```bash
mkdir 1-hpc_linux 2-sequencing_qc logs
```
Hemos creado los directorios para la práctica 1 y 2 (verlos con `ls`)
- **touch**: crear un archivo vacío
```bash
touch file_name
```
Por ejemplo, creemos un archivo vacío dentro del directorio 1-hpc_linux
```bash
cd 1-hpc_linux
touch saludo.txt
ls -lh
```
- **echo**: imprimir en la terminal
```bash
echo "Hola mundo!"
```
También podemos usar `printf`. Sin embargo, este requiere ser más específico
```bash
printf "Hola mundo!"
printf "Hola mundo!\n"
```
Cualquier impresión en la terminal se puede guardar en un archivo usando una flecha `>`.
```bash
printf "Hola mundo!\n" > saludo.txt
```
Si el archivo no existe, se creará al especificar con la flecha. Si el archivo existe, una flecha reemplazará el contenido del archivo original. Por otro lado, dos flechas `>>` aumentará al contenido original.
```bash
printf "Adiós mundo!\n" >> despedida.txt
printf "Adiós mundo!\n" >> saludo.txt
```
- **cat**: concatenar el contenido de uno o más archivos e imprimir el resultado
```bash
cat despedida.txt
cat saludo.txt
cat despedida.txt saludo.txt
```
El contenido concatenado también se puede guardar o añadir a otro archivo con las flechas.
- **less**: mostrar archivos largos de manera segura
```bash
less ../../course_files/transcripts.fasta
```
Se abre una ventana que podemos explorar usando las flechas del teclado. Podemos controlar el ajuste de línea con la opción `-S`
```bash
less -S ../../course_files/transcripts.fasta
```
Para salir, usamos la tecla `q`
- **ln**: crear un enlace desde una dirección a otra
```bash
ln -s /data/courses/courses2026/course_files/transcripts.fasta .
ls -lh
```
Útil para acortar la longitud de los comandos y facilitar el trabajo en un solo ambiente. Se pueden crear enlaces de archivos y directorios.
```bash
ln -s /data/courses/courses2026/course_files/ .
```
- **cp**: copiar archivos y directorios
```bash
cp saludo.txt saludo_copia.txt
cp course_files/saludo.sh .
```
Para copiar directorios con el contenido, agregamos la opción `-r`
- **mv**: mover archivos y directorios, renombrar archivos
```bash
mv saludo.txt saludo_y_despedida.txt
```
Funciona con un archivo o dirección "desde" a un archivo o dirección "hasta". Si se elige un "hasta" que ya existe, se reemplazará el archivo original, perdiendo su contenido.
- **rm**: eliminar archivos y directorios
```bash
rm saludo_copia.txt
```
Para eliminar directorios con el contenido, agregamos la opción `-r`. Una vez eliminado, el archivo no puede ser recuperado. En lo posible, evitar usar direcciones absolutas para prevenir errores irreversibles.
- **nano**: editar archivos
```bash
nano despedida.txt
```
Si el archivo no existe, se creará una ventana vacía en la cual podemos escribir contenido. Si el archivo existe, se abrirá una ventana con el contenido para editar. Agreguemos lo siguiente:
```bash
#!/bin/bash
echo "Adiós mundo!"
```
Salimos con `^X`, y para guardar el contenido con `^Y` y `ENTER` para mantener el mismo nombre.

## 5. Permisos de lectura, escritura y ejecución

Cada archivo o directorio tiene:
- Dueño
- Grupo
- Permisos

Por ejemplo, usando `ls -l`. Podemos observar algo como:
```bash
drwxr-x--- 2 neltuma genpob2025 4096 saludo_y_despedida.txt
```
Donde `r`, `w` y `x` se refiere a los permisos de lectura, escritura y ejecución, respectivamente. Se muestran en el orden de permisos para el dueño, el grupo y todos los demás.  
Intentemos ejecutar un script de ejemplo. Esto se puede hacer de dos maneras:
```bash
./saludo.sh
bash saludo.sh
```
Podemos cambiar los permisos de ejecución con `chmod`
```bash
chmod +x despedida.txt
./despedida.txt
```

## 6. Comandos de manipulación de datos
Tenemos dos listas correspondientes de datos de prueba
```bash
cp course_files/hpc_linux/WCVP_* .
less WCVP_names.txt
less WCVP_region.txt
```
Usando `paste` pegamos ambos archivos de lado a lado
```bash
paste WCVP_names.txt WCVP_region.txt > WCVP_names_region.txt
less WCVP_names_region.txt
```
Seguimos explorando el contenido usando `head` o `tail` para ver las primeras o las últimas líneas, respectivamente.
```bash
head WCVP_names_region.txt
tail WCVP_names_region.txt
```
Usando `grep` podemos filtrar la información en base a patrones específicos en el archivo
```bash
grep Peru WCVP_names_region.txt > WCVP_Peru.txt
less WCVP_Peru.txt
```

## 7. ¿Cómo usamos el HPC?

Los procesos o trabajos se someten usando SLURM (Simple Linux Utility for Resource Management), el cual es un organizador común que evita que se sature el sistema y se ejecuten trabajos de forma ordenada y justa.  
Volvemos a la carpeta de trabajo, donde crearemos un script de Slurm de prueba.
```bash
cd ~/1-hpc_linux
nano hpc_script1.sh
```
Copiaremos lo siguiente
```bash
#!/bin/bash

# Nombre del proceso:
#SBATCH --job-name=primerjob

# Proyecto:
#SBATCH --account=USERNAME
#SBATCH --partition=standard # Nombre de la partición

# Recursos:
#SBATCH --time=01:00:00 # Límite de tiempo de corrida
#SBATCH --cpus-per-task=1 # Límite de CPUs para cada tarea en tareas de múltiples instancias
#SBATCH --mem=2G # Límite de memoria

# Archivos de salida
#SBATCH --output=/data/courses/course2026/USERNAME/logs/primerjob_o%j # Nombre del archivo de salida stdout
#SBATCH --error=/data/courses/course2026/USERNAME/logs/primerjob_e%j # Nombre del archivo de error stderr

# Ambiente de trabajo
set -o errexit
set -o nounset

module --quiet purge
module list

# Mensaje informativo
echo "Job iniciado en:"
date
echo "Nodo:"
hostname

# Comando a ejecutar
sed -n '15,50p' /data/courses/course2026/course_files/WCVP_names.txt > /data/course/course2026/USERNAME/1-hpc_linux/WCVP_names_15..50.txt
wc -l /data/courses/course2026/USERNAME/1-hpc_linux/WCVP_names_15..50.txt
sleep 60

echo "Job finalizado en:"
date
```
Guardamos el script y lo sometemos a correr:
```bash
sbatch hpc_script1.sh
```
Registramos el número de trabajo y monitoreamos el estado de la siguiente manera:
```bash
squeue -u USERNAME
```
De ser necesario, podemos cancelar un proceso especificando el número de trabajo de la siguiente manera:
```bash
scancel 12345
```
Dependiendo del script, al finalizar los resultados de interés pueden estar en stdout o en el archivo creado en los comandos. Tanto stdout como stderr tendrán el número de trabajo asociados.
