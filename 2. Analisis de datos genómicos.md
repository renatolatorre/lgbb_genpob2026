# Análisis de datos genómicos y control de calidad

En este tutorial veremos los pasos básicos para examinar y limpiar datos de secuenciación de siguiente generación antes de análisis más avanzados. TRabajaremos con archivos FASTQ, evaluaremos la calidad de lecturas, y removeremos adaptadores y bases de baja calidad.  
El objetivo es entender por qué funciona cada paso y cómo las características de los datos influyen en los resultados de los siguientes análisis de genómica de poblaciones.

## 1. Preparación de programas y materiales
Los programas usados en esta práctica se instalarán usando Conda, un gestor de paquetes y ambientes/entornos. Existen distintas presentaciones: Miniconda y Anaconda, las cuales son esencialmente extensiones de Conda. Miniconda mantiene un balance adecuado entre espacio y funcionalidad.  
La instalación de software se realiza en ambientes, los cuales son independientes para evitar colisiones entre las dependencias. Comenzamos instalando un ambiente para el curso:
```bash
conda env create --file sequencing_qc.yml
```
El archivo `.yml` contiene la información de los paquetes a instalar y el nombre del ambiente.  
Para listar este y otros ambientes usar:
```bash
conda env list
```
Luego, para activar este ambiente y todos los programas que incluye, correr:
```bash
conda activate 2026_sequencing_qc
```
Podemos verificar los paquetes y programas instalados en el entorno activo con:
```bash
conda list
```
Notar que, además de los paquetes instalados específicamente para el ambiente, la lista incluirá paquetes predeterminados necesarios para el funcionamiento de Conda.  
Se recomienda revisar la documentación de Conda para conocer otras funcionalidades, entre ellas:
- `conda info`
- `conda create`
- `conda env remove`
- `conda install`
- `conda remove`
> [!IMPORTANT]
> :grey_question: ¿Cuáles son las ventajas de Conda para la instalación de programas y el uso de ambientes?  
> :grey_question: ¿Por qué perefiríamos usar Conda en lugar de métodos tradicionales para la gestión, instalación y uso de programas bioinformáticos?

Para empezar, nos situamos en el directorio de trabajo
```bash
mkdir 2-sequencing_qc
cd 2-sequencing_qc
```
## 2. Obtención de datos de secuenciación
Para facilitar el desarrollo de la práctica en el tiempo limitado de la sesión, se proveen archivos de secuenciación de prueba. Sin embargo, se puede trabajar de la misma manera con datos originales.

Para nuestros fines, los datos crudos de secuenciación se almacenan en la base de datos SRA (Sequence Read Archive), los cuales pueden obtenerse usando el programa SRA-toolkit de la siguiente manera:
```bash
prefetch SRX24311185 --max-size 30GB
```
El código `SRX24311185` corresponde a datos de secuenciación Hi-C de una de las dos librerías usadas para el ensamblado híbrido del genoma a escala de cromosoma del algarrobo (Neltuma pallida).
Notar que el tamaño máximo (`--max-size`) no es necesario para este ejemplo.

Este comando descarga una versión comprimida de los datos (`.sra`). La ventaja de esto, en comparación con una descarga directa de las lecturas, es una descarga más rápida y menor dependencia de la conexión de red. Además, en caso de problemas de conexión, la descarga puede interrumpirse y reanudarse posteriormente.

Los archivos comprimidos deben convertirse a datos de lectura y calidad usando:
```bash
fasterq-dump --split-files SRR28745402
```
> [!IMPORTANT]
> :grey_question: ¿Por qué usar SRA-toolkit para obtener datos crudos de secuenciación? ¿Cuáles son las alternativas?

## 2. Archivos FASTQ
### 2.1 El formato FASTQ
Los datos de secuenciación de Illumina se almacenan en archivos FASTQ. Cada lectura de secuenciación ocupa cuatro líneas:
1. **Identificador de lecturas**
Comienza con `@` y contiene información acerca del instrumento y la lectura.
2. **Secuencia**
Secuencia nucleotídica (A, C, G, T o N).
3. **Separador**
Un símbolo de suma `+`.
4. **Calidades**
Caracteres ASCII que codifican la calidad de cada base.  
Por ejemplo,
```bash
less -S /mnt/E/courses/course2026/sequencing_qc/SRR28745402_1.fastq
```
Contar cuántas lecturas hay en el archivo
```bash
grep -c "^@" /mnt/E/courses/course2026/sequencing_qc/SRR28745402_1.fastq
```
Examinar la distribución de longitudes de lectura
```bash
cat /mnt/E/courses/course2026/sequencing_qc/SRR28745402_1.fastq | awk '(NR%4==2){print length($0)}' | sort | uniq -c
```
Obtener estadísticos de resumen de las lecturas
```bash
seqkit stats --all --tabular /mnt/E/courses/course2026/sequencing_qc/SRR28745402_1.fastq > SRR28745402_1.stats
csvtk csv2md --alignments left --tabs SRR28745402_1.stats | less -S
```
### 2.2 ¿Cómo interpretamos los caracteres de calidad?
- Identificar el caracter ASCII
- Identificar el puntaje Q correspondiente (número ASCII - 33)
- Calcular la probabilidad estimada. Q = -10log10(P). P = 10^(-Q/10)

![image](https://github.com/user-attachments/assets/d86910fc-c7f7-4208-b8d4-9991678686f9)

## 3. Evaluación de la calidad con FastQC
FastQC permite tener un primer vistazo a la calidad de secuenciación y otras características de los datos. Para cada archivo de salida, se reporta:
- Puntajes de calidad por base
- Contenido de GC
- Distribución de longitudes de secuencias
- Contaminación por adaptadores
- Secuencias sobrerrepresentadas

```bash
fastqc -t 5 -o . /mnt/E/courses/course2026/sequencing_qc/SRR28745397_*.fastq
```
Descargar los resultados a nuestra computadora local. Abrir una terminal, moverse a un directorio fácil de acceder (por ejemplo, el Escritorio) y copiar (cambiar USERNAME por el nombre de usuario):
```
scp USERNAME@161.132.238.252:/home/USERNAME/2-sequencing_qc/*.html .
```
Abrir el reporte en HTML en un navegador
> [!IMPORTANT]
> :grey_question: ¿Qué significan las gráficas y cuadros en los resultados de FastQC? Para una guía sobre cada uno de estos, revisar [aquí](https://rtsf.natsci.msu.edu/genomics/technical-documents/fastqc-tutorial-and-faq.aspx)

## 4. Trimado y remoción de adaptadores
El control de calidad incluye la remoción de
- Secuencias de baja calidad
- Contaminantes
- Adaptadores
- Lecturas de baja complejidad
- Lecturas extremadamente cortas
- Duplicados
- Sitios ambiguos

Entre algunas herramientas que podemos usar, se encuentran Trimmomatic, cutadapt, fastp, AdapterRemoval, entre otras. Muchos de estos requieren la secuencia de los adaptadores, los cuales son conocidos para plataformas Illumina. Sin embargo, librerías indexadas pueden requerir la especificación de bases ambiguas.

Para verificar o identificar empíricamente las secuencias de adaptadores se recomienda:
```bash
AdapterRemoval --threads 5 --file1 /mnt/E/courses/course2026/sequencing_qc/SRR28745402_1.fastq --file2 /mnt/E/courses/course2026/sequencing_qc/SRR28745402_2.fastq --identify-adapters
```
Una vez identificados los adaptadores, se pueden usar en una corrida completa de control de calidad
```bash
AdapterRemoval --file1 /mnt/E/courses/course2026/sequencing_qc/SRR28745402_1.fastq \
--file2 /mnt/E/courses/course2026/sequencing_qc/SRR28745402_2.fastq \
--adapter1 AGATCGGAAGAGCACACGTCTGAACTCCAGTCACNNNNNNATCTCGTATGCCGTCTTCTGCTTG \
--adapter2 AGATCGGAAGAGCGTCGTGTAGGGAAAGAGTGTAGATCTCGGTGGTCGCCGTATCATT \
--mm 3 --minlength 30 --trimns --trimqualities \
--minquality 30 --basename SRR28745402 \
--threads 5 --collapse \
--settings SRR28745402.settings
```
Esto generará múltiples archivos, incluyendo lecturas pareadas recortadas, lecturas sin par, lecturas colapsadas y lecturas descartadas.  
También se obtiene un archivo `settings` con los parámetros de la corrida y resultados principales.

El colapso de lecturas ocurre cuando existe un sobrelapamiento mínimo de 11 pares de bases (valor por defecto).
> [!IMPORTANT]
> :grey_question: ¿Qué hace cada una de las opciones en el comando completo de AdapterRemoval? Pista: usar `AdapterRemoval --help`

### Inspección de longitudes de lectura
Podemos obtener un resumen de las longitudes de lectura usando:
```
tail -n +49 SRR28745402.settings
tail -n +49 SRR28745402.lengths
```

### Control de calidad con fastp
La herramienta fastp funciona de manera similar y también incluye el colapso de lecturas sobrelapadas. Además, genera un archivo HTML que resume estadísticas antes y después del control de calidad
```
fastp --in1 /mnt/E/courses/course2026/sequencing_qc/SRR28745402_1.fastq \
--in2 /mnt/E/courses/course2026/sequencing_qc/SRR28745402_2.fastq \
--stdout --json /dev/null \
--html fastp_overlaps.html > /dev/null
```
> [!IMPORTANT]
> :grey_question: ¿Cuáles son las principales diferencias en los gráficos y cuadros de resumen de los datos de secuenciación antes y después del control de calidad?

## 5. Control de calidad para lecturas largas
Herramientas como FastQC no están diseñadas para datos de lecturas largas, ya que estas tienen distintos perfiles de errores, longitudes de lectura distintos, y artefactos específicos para la plataforma (ONT / PacBio). POr este motivo, los datos de lecturas largas necesitan herramientas de control de calidad distintos.

### 5.1 Métricas de calidad en lecturas largas
Para el control de calidad de lecturas largas, nos concentramos en:
- Distribución de longitud de lecturas
- Distribución de calidad de lecturas
- Rendimiento total
- N50
- Contenido de GC
Comenzamos explorando los archivos FASTQ
```bash
less /mnt/E/courses/course2026/sequencing_qc/long_Reads.fastq
```
Al igual que para lecturas cortas, los encabezados de ONT incluyen información sobre la lectura, la celda de flujo y la corrida de secuenciación.  
¿Cuántas lecturas tiene el archivo de ejemplo? ¿Cómo es la distribución de longitudes de lectura?

### 5.2 Control de calidad de lecturas largas
NanoPlot es una herramienta de control de calidad comúnmente usada para lecturas largas. Genera estadísticas de resumen y gráficas específicas para este tipo de datos.  
```
NanoPlot --fastq /mnt/E/courses/course2026/sequencing_qc/long_reads.fastq --outdir longread_qc --threads 5
```
Descargar los archivos de resultado e inspeccionar el reporte en HTML y las figuras.
### 5.3 Trimado y filtrado de lecturas largas
Para lecturas de ONT, usaremos la herramienta Porechop para detectar y eliminar adaptadores, barcodes, o lecturas quiméricas. Luego, NanoFilt servirá para filtrar las lecturas resultantes según un rango de longitudes y calidades.
```
porechop -i hared_data/long_reads/example_ont.fastq.gz -o _longread_qc/example_ont_porechop.fastq.gz --threads 4
zcat smple_ont_porechop.fastq.gz | NanoFilt -q 9 -l 500 | gzip > sqc/example_ont_filtered.fastq.gz
```
Se recomienda revisar la calidad luego de procesar las lecturas.
